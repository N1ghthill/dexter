name: Dexter Release Linux

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_release:
        description: Publicar GitHub Release
        required: false
        type: boolean
        default: true
      tag:
        description: "Tag semver para execucao manual (ex: v0.1.0 ou v0.1.1-rc.1)"
        required: false
        type: string

concurrency:
  group: dexter-release-linux-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  release-linux:
    name: Release Linux (AppImage + deb)
    runs-on: ubuntu-latest
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb xauth

      - name: Validate quality gate
        run: |
          npm run check
          npm run build
          xvfb-run --auto-servernum --server-args="-screen 0 1440x900x24" npx playwright test

      - name: Build Linux artifacts
        run: npm run dist

      - name: Resolve release metadata
        id: meta
        run: |
          semver_pattern='^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'
          should_publish="false"
          tag=""
          package_version="$(node -p "require('./package.json').version")"

          if [ "${GITHUB_EVENT_NAME}" = "push" ] && [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            should_publish="true"
            tag="${GITHUB_REF_NAME}"
          elif [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            should_publish="$(node -e "const fs = require('fs'); const payload = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')); process.stdout.write(String(payload.inputs?.publish_release ?? 'true'));")"
            tag="$(node -e "const fs = require('fs'); const payload = JSON.parse(fs.readFileSync(process.env.GITHUB_EVENT_PATH, 'utf8')); process.stdout.write(String(payload.inputs?.tag ?? ''));")"
          fi

          if [ "${should_publish}" = "true" ] && [ -z "${tag}" ]; then
            echo "Para publicar release manual, informe uma tag (ex: v0.1.0)."
            exit 1
          fi

          if [ "${should_publish}" = "true" ] && ! [[ "${tag}" =~ ${semver_pattern} ]]; then
            echo "Tag invalida para release: '${tag}'. Use semver com prefixo v (ex: v0.1.0 ou v0.1.1-rc.1)."
            exit 1
          fi

          if [ "${should_publish}" = "true" ]; then
            tag_version="${tag#v}"
            if [ "${tag_version}" != "${package_version}" ]; then
              echo "Tag '${tag}' diferente da versao do package.json (${package_version})."
              echo "Atualize a versao do pacote ou use a tag correspondente."
              exit 1
            fi
          fi

          if [ -z "${tag}" ]; then
            tag="linux-build-${GITHUB_RUN_NUMBER}"
          fi

          echo "should_publish=${should_publish}" >> "${GITHUB_OUTPUT}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "name=Dexter Linux ${tag}" >> "${GITHUB_OUTPUT}"

      - name: Verify artifacts and generate checksums
        run: |
          shopt -s nullglob
          appimages=(release/*.AppImage)
          debs=(release/*.deb)

          if [ "${#appimages[@]}" -eq 0 ] || [ "${#debs[@]}" -eq 0 ]; then
            echo "Artefatos esperados nao encontrados em release/."
            ls -la release || true
            exit 1
          fi

          sha256sum "${appimages[@]}" "${debs[@]}" > release/SHA256SUMS.txt
          cat release/SHA256SUMS.txt

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dexter-linux-${{ steps.meta.outputs.tag }}
          path: |
            release/*.AppImage
            release/*.deb
            release/SHA256SUMS.txt
          if-no-files-found: error

      - name: Publish GitHub Release
        if: steps.meta.outputs.should_publish == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.name }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: |
            release/*.AppImage
            release/*.deb
            release/SHA256SUMS.txt
          fail_on_unmatched_files: true
