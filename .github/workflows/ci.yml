name: Dexter CI

on:
  push:
    branches:
      - main
      - master
  pull_request:
  workflow_dispatch:

concurrency:
  group: dexter-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: Typecheck + Coverage Gate
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Typecheck + coverage gate
        run: npm run quality:ci

  e2e:
    name: E2E + Visual
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb xauth

      - name: Build app
        run: npm run build

      - name: Run E2E tests (Electron)
        run: |
          set +e
          xvfb-run --auto-servernum --server-args="-screen 0 1440x900x24" npx playwright test > e2e-ci.log 2>&1
          status=$?
          cat e2e-ci.log
          if [ "$status" -ne 0 ]; then
            tail -n 40 e2e-ci.log | while IFS= read -r line; do
              echo "::error::$line"
            done
            exit "$status"
          fi

      - name: Upload Playwright artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            test-results/
          if-no-files-found: ignore

      - name: Upload E2E log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-log
          path: e2e-ci.log
          if-no-files-found: ignore

  deb-smoke:
    name: DEB Smoke (Container)
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build .deb package
        run: |
          npm run build
          npx electron-builder --linux deb --publish never

      - name: Smoke test .deb in clean Ubuntu container
        run: |
          docker run --rm \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -w /workspace \
            ubuntu:24.04 \
            bash scripts/ci-deb-smoke.sh

      - name: Upload DEB smoke artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deb-smoke-artifacts
          path: artifacts/deb-smoke/
          if-no-files-found: ignore
